@if (toastMessage) {
  <div class="toast-popup">
    {{ toastMessage }}
  </div>
}

<div class="main-component">
  <div class = "navbar">
    <div class="logo" (click)="toggleExpense()">NEW TRANSACTION</div>
    <div class="signout-btn" (click)="logout()">LOG OUT</div>
  </div>
  <div class = "container">
    <div class = "left-profile-section">
      <div class = "profile-display">
        <div class="heading">HELLO,</div>
        <form [formGroup]="profileForm" class = "details">
          <div class="label">Username</div>
          <input class="username" formControlName="username" [placeholder]="username" />
          <div class="label">Email</div>
          <div class="email">{{ email || 'Email' }}</div>
        </form>
        <div class="update-bttn" (click)="editProfileMode?updateProfile():editProfileFormActivate()">{{editProfileMode?'UPDATE':'EDIT PROFILE'}}</div>
      </div>
      <hr>
        <div class="quick-links">
          <div (click)="toggleExpense()"[ngClass]="{'open':isExpenseOpen}">± New Expense</div>
          <div (click)="getReport()">◙ Get Report</div>
        </div>
      </div>
      <div class = "right-service-section">
        <div class = "left-service-section">
          <div class="scan-expense-section">
            <div class="scan-bttn" (click)="scanUploadImage()">SCAN/UPLOAD</div>
            <div class="description">Scan your Receipt, Add Transaction Now!</div>
          </div>
          <div class="category-section">
            <div class="category-header">
              @if (showAddCategory) {
                <div class="icon" (click)="toggleAddCategory()">x</div>
              }
              @if (!showAddCategory) {
                <div class="icon" (click)="toggleAddCategory()">+</div>
              }
              <div class="new-category-bttn" (click)="toggleAddCategory()" [ngClass]="{'active':showAddCategory}">{{selectedCategoryId==null?'New Category':'Edit Category'}}</div>
            </div>
            @if (showAddCategory) {
              <div class="add-category-section">
                <div class="new-category-icon">ICON</div>
                <div class="icon-list">
                  @for (icon of availableIcons; track icon) {
                    <div
                      (click)="selectedIconId = icon.iconId"
                      [class.selected]="selectedIconId === icon.iconId"
                      class="icon-option"
                      >
                      <img [src]="icon.iconImageUrl" class = "icon-image"/>
                    </div>
                  }
                </div>
                <div class="icon-label">Select an icon suitable for this category</div>
                <div class="name-label">Name</div>
                <input class="category-name" type="text" [(ngModel)]="categoryNameInput" placeholder="Enter Category Name" name="category-name"/>                           <div class="bttns">
                @if (editCategoryMode) {
                  <div class="add-category-bttn" (click)="updateCategory(editCategoryData)"> Save Changes </div>
                }
                @if (!editCategoryMode) {
                  <div class="add-category-bttn" (click)="saveCategory(editCategoryData)"> Add Category </div>
                }
                <div class="cancel-bttn" (click)="cancelCategoryDelete()">Cancel</div>
              </div>
            </div>
          }
          <input class="search-bar" placeholder="Search Category" name="search-bar" (input)="onSearch($event.target.value)"/>
          <div class="category-list">
            @for (c of filteredCategories; track c) {
              <div
                class="category-tag"
                [ngClass]="{ 'selected': selectedCategoryId === c.categoryId }"
                (click)="selectCategory(c.categoryId)"
                >
                <img class="category-icon" [src]="c.iconUrl || '/assets/microsoft-logo.png'">
                <div class="category-name">{{ c.categoryName }}</div>
              </div>
            }
          </div>

          @if (selectedCategoryId!=null) {
            <div class="category-actions">
              <div (click)="displayEditCategorySection()" class="editbttn">Edit Category</div>
              <div (click)="confirmDeleteCategory()" class="deletebttn">Delete</div>
            </div>
          }
        </div>
        @if (showDeletePopup) {
          <div class="delete-popup">
            <div class="popup-content">
              <p>Are you sure you want to delete this category : {{categoryNameInput}}?</p>
              <button (click)="deleteCategory()">Yes, Delete</button>
              <button (click)="cancelDelete()">Cancel</button>
            </div>
          </div>
        }
        <div class="bar-graph-section">
          <div class="bar-graph-heading">GRAPH</div>
          <div class="vertical-graph">
            @for (row of getGraphRows(); track row.id) {
              <div class="v-bar-item">
                <div class="v-bar-value">
                  ₹{{ row.value | number:'1.0-0' }}
                </div>
                <div class="v-bar-bg">
                  <div class="v-bar" [style.height.%]="getBarWidth(row.value)"></div>
                </div>
                <img class="v-bar-label" [src]="row.name" width="12" height="14"/>
              </div>
            }
          </div>

          @if (allGraphRowsZero()) {
            <div class="empty-graph-message">
              No transactions found for expense summary.
            </div>
          }
        </div>
        <div class="grpah-description">This Grpah computes expenses tracked for each category</div>
      </div>
      <div class = "right-service-service-section">
        <div class="new-heading-icon" (click)="toggleExpense()">⨉</div>
        @if (isExpenseOpen) {
          <div class="new-expense">
            <div class="new-expense-form">

              <div class="header">
                <div class="heading">NEW TRANSACTION</div>
              </div>

              <div class="form" [formGroup]="transactionForm">
                <!-- AMOUNT -->
                <div class="amount-section">
                  <input placeholder="0.0"
                        class="amount"
                        formControlName="transactionAmount"
                        type="number" min=0 >
                  <div class="amount-symbol">RS</div>
                </div>

                <!-- DESCRIPTION -->
                <input class="description"
                      placeholder="Description (Optional)"
                      formControlName="transactionDescription">

                <!-- RECEIVER -->
                <input class="revicer-name"
                      placeholder="Enter Receiver's / Sender's Name"
                      formControlName="reciverSenderName" required="This field can't be empty">

                <!-- DATE INPUTS -->
                <div class="expense-date">
                  <input type="number"
                        placeholder="dd"
                        class="date"
                        maxlength="2"
                        max="31"
                        min="1"
                        formControlName="day"
                        (input)="onManualDateChange()">

                  <input type="number"
                        placeholder="mm"
                        class="month"
                        maxlength="2"
                        max="12"
                        min="1"
                        formControlName="month"
                        (input)="onManualDateChange()">

                  <input type="number"
                        placeholder="yyyy"
                        class="year"
                        minlength="4"
                        maxlength="4"
                        min="2000"
                        formControlName="year"
                        (input)="onManualDateChange()">
                </div>

                <!-- EXPENSE TYPE -->
                <div class="expense-type">
                  <div class="type-option"
                      *ngFor="let type of expenseTypes"
                      (click)="selectExpenseType(type)"
                      [class.active]="transactionForm.value.expenseTypeId === type.expenseTypeId">
                    {{ type.expenseTypeName }}
                  </div>
                </div>

                <!-- CATEGORY -->
                <select class="category-select" formControlName="categoryId">
                  <option [ngValue]="null" disabled>Select Category</option>
                  <option *ngFor="let c of categories" [value]="c.categoryId">
                    {{ c.categoryName }}
                  </option>
                </select>

                <!-- PAYMENT MODE -->
                <select class="mode-of-payment-select" formControlName="modeOfPaymentId">
                  <option [ngValue]="null" disabled>Select a Mode of Payment</option>
                  <option *ngFor="let mode of modesOfPayment" [value]="mode.modeOfPaymentId">
                    {{ mode.modeOfPaymentName }}
                  </option>
                </select>

                <!-- SUBMIT BUTTON -->
                <div class="add-bttn" (click)="submitTransaction()">
                  Add Expense
                </div>
              </div>
          </div>

              <!-- CALENDAR SECTION -->
              <div class="calender">
                <div class="header">
                  <select class="month"
                          [(ngModel)]="month"
                          (change)="updateCalendar()">
                    <option *ngFor="let m of monthNames; index as i" [value]="i+1">
                      {{ m }}
                    </option>
                  </select>

                  <select class="year"
                          [(ngModel)]="year"
                          (change)="updateCalendar()">
                    <option *ngFor="let y of years"
                            [value]="y">
                      {{ y }}
                    </option>
                  </select>
                </div>

                <div class="weekdays">
                  <div class="week-days">
                    <div class="icon">M</div>
                    <div class="icon">T</div>
                    <div class="icon">W</div>
                    <div class="icon">T</div>
                    <div class="icon">F</div>
                    <div class="icon">S</div>
                    <div class="icon">S</div>
                  </div>

                  <div class="dates">
                    <div class="icon"
                        *ngFor="let d of calendarDays"
                        [class.empty]="d === null"
                        [class.selected]="selectedDay === d"
                        (click)="d ? selectDate(d) : null">
                      {{ d || '' }}
                    </div>
                  </div>
                </div>

                <div class="today-bttn"
                    (click)="selectToday()">
                  Select Today
                </div>
              </div>
            </div>
        }
        <div class="history-section">
          <div class="heading">PREVIOUS TRANSACTIONS</div>
          <div class="transaction-history-wrapper" (scroll)="onScroll($event)">
            <div class="transaction-history-container">
              <div *ngFor="let date of recentTransactionsByDate | keyvalue" class="th-date-group">
                <div class="th-date-header">
                  <div class="th-date-dot"></div>
                  <div class="th-date-label">{{ date.key | date:'MMM d' }}</div>
                </div>
                <div class="th-transactions">
                  <div *ngFor="let t of date.value" class="th-transaction-card">
                    <div class="th-transaction-header">
                      <div class="th-transaction-left">
                        <div>
                          <div>
                            <div class="th-recipient">from {{ t.reciverSenderName }}</div>
                            <div class="th-transaction-time">
                              {{ t.createdOn| date:'shortTime' }}
                            </div>
                          </div>

                          <!-- Amount Badge -->
                          <div
                            class="th-amount-badge"
                            [ngClass]="{
                              'th-income': t.expenseTypeId === 1,
                              'th-expense': t.expenseTypeId === 2
                            }"
                          >
                            <span class="th-amount-symbol">
                              {{ t.expenseTypeId === 1 ? '⇲' : '⇱' }}
                            </span>
                            <span class="th-amount">₹{{ t.transactionAmount }}</span>
                          </div>
                        </div>
                        <div
                          class="th-type-badge"
                          [ngClass]="{
                            'th-income': t.expenseTypeId === 1,
                            'th-expense': t.expenseTypeId === 2
                          }"
                        >
                          {{ t.expenseTypeId === 1 ? 'Income' : 'Expense' }}
                        </div>
                        <div class="th-transaction-footer">
                          <div class="th-categories">
                            <div class="th-category-tag">
                              <img class="th-category-icon" src={{findCategoryIcon(t.categoryId)}}/>
                              <span>
                                {{ findCategoryName(t.categoryId) }}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="th-actions">
                          <button class="th-action-btn th-edit">Edit</button>
                          <button class="th-action-btn th-delete">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="fade-out-overlay" [class.hidden]="!isAtBottom"></div>
          <div class="floating-report-btn" [class.show]="isAtBottom" (click)="getReport()">GET COMPLETE STATEMENT</div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div>DISCLAIMER : This communication (including any attachments) is for the use of the intended recipient(s) only and may contain information that is confidential, privileged or legally protected. Any unauthorized use or dissemination of this communication is strictly prohibited. If you have received this communication in error, please immediately notify the sender by return e-mail message and delete all copies of the original communication including attachments. Thank you for your cooperation.</div>
  </div>
</div>

<div class="signUpContainer">
  <div class="signUpHeader">
    <div> Get Started! </div>
  </div>

  <!-- SUCCESS POPUP -->
  @if (showSuccessPopup) {
    <div class="popup successPopup">
      <div class="popupContent">
        <div class="popupHeader">
          <strong>Success</strong>
          <button class="closeBtn" (click)="closeSuccessPopup()">âœ•</button>
        </div>
        <div class="popupBody">{{ successMessage }}</div>
      </div>
    </div>
  }

  <!-- ERROR POPUP -->
  @if (showErrorPopup) {
    <div class="popup errorPopup">
      <div class="popupContent">
        <div class="popupHeader">
          <strong>Error</strong>
          <button class="closeBtn" (click)="closeErrorPopup()">âœ•</button>
        </div>
        <div class="popupBody">{{ errorMessage }}</div>
      </div>
    </div>
  }

  <!-- Validation messages (same as your previous behavior) -->
  @if (apiErrors.length > 0) {
    <div class="api-errors">
      <ul>
        @for (error of apiErrors; track error) {
          <li>{{ error }}</li>
        }
      </ul>
    </div>
  }

  <form class="signUpForm" (ngSubmit)="onSubmit()" #signUpForm="ngForm" novalidate>
    <div class="username">
      <div class="inputGroup">
        <input
          type="text"
          id="username"
          name="username"
          placeholder="ðŸ‘¤ User Name"
          required
          maxlength="15"
          [(ngModel)]="username"
          #usernameInput="ngModel"
          [disabled]="isLoading"
          />
          <!-- Show requirements when touched/dirty OR when submitted and invalid -->
          @if ((usernameInput.touched || usernameInput.dirty) || (submitted && usernameInput.invalid)) {
            <ul class="requirements"
              >
              <li [class.valid]="username.length > 0">Required</li>
              <li [class.valid]="username.length <= 15">Max 15 characters</li>
              <li [class.valid]="username.length >= 3">Min 3 characters</li>
            </ul>
          }
          @if ((usernameInput.invalid && (usernameInput.touched || usernameInput.dirty)) || (submitted && usernameInput.invalid)) {
            <div class="error"
              >
              @if (usernameInput.errors?.['required']) {
                <div>Username is required.</div>
              }
              @if (usernameInput.errors?.['maxlength']) {
                <div>Username cannot exceed 15 characters.</div>
              }
            </div>
          }
        </div>
      </div>

      <div class="inputGroup">
        <input
          type="email"
          id="email"
          name="email"
          placeholder="âœ‰ï¸ Enter your email"
          required
          email
          [(ngModel)]="email"
          #emailInput="ngModel"
          [disabled]="isLoading"
          />
          <!-- Show requirements when touched/dirty OR when submitted and invalid -->
          @if ((emailInput.touched || emailInput.dirty) || (submitted && emailInput.invalid)) {
            <ul class="requirements"
              >
              <li [class.valid]="email.length > 0">Required</li>
              <li [class.valid]="emailInput.valid && email.length > 0">Valid email format</li>
            </ul>
          }
          @if ((emailInput.invalid && (emailInput.touched || emailInput.dirty)) || (submitted && emailInput.invalid)) {
            <div class="error"
              >
              @if (emailInput.errors?.['required']) {
                <div>Email is required.</div>
              }
              @if (emailInput.errors?.['email']) {
                <div>Enter a valid email.</div>
              }
            </div>
          }
        </div>

        <div class="inputGroup">
          <input
            type="password"
            id="password"
            name="password"
            placeholder="ðŸ”‘ Enter password"
            required
            [(ngModel)]="password"
            #passwordInput="ngModel"
            (input)="validatePassword()"
            [disabled]="isLoading"
            />
            <!-- Show requirements when touched/dirty OR when submitted and password invalid -->
            @if ((passwordInput.touched || passwordInput.dirty) || (submitted && (!allPasswordValidationsMet() || passwordInput.invalid))) {
              <ul class="password-requirements"
                >
                <li [class.valid]="passwordValidations.length">Min 6 characters</li>
                <li [class.valid]="passwordValidations.upper">At least one uppercase letter</li>
                <li [class.valid]="passwordValidations.lower">At least one lowercase letter</li>
                <li [class.valid]="passwordValidations.number">At least one number</li>
                <li [class.valid]="passwordValidations.special">At least one special character</li>
              </ul>
            }
            @if ((passwordInput.invalid && (passwordInput.touched || passwordInput.dirty)) || (submitted && passwordInput.invalid)) {
              <div class="error"
                >
                @if (passwordInput.errors?.['required']) {
                  <div>Password is required.</div>
                }
              </div>
            }
          </div>

          <div class="inputGroup">
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              placeholder="ðŸ”„ï¸ Re-enter password"
              required
              [(ngModel)]="confirmPassword"
              #confirmPasswordInput="ngModel"
              [disabled]="isLoading"
              />
              <!-- Show requirements when touched/dirty OR when submitted and passwords don't match -->
              @if ((confirmPasswordInput.touched || confirmPasswordInput.dirty) || (submitted && (!passwordsMatch || confirmPasswordInput.invalid))) {
                <ul class="requirements"
                  >
                  <li [class.valid]="confirmPassword.length > 0">Required</li>
                  <li [class.valid]="passwordsMatch">Must match password</li>
                </ul>
              }
              @if ((confirmPasswordInput.invalid && (confirmPasswordInput.touched || confirmPasswordInput.dirty)) || (submitted && confirmPasswordInput.invalid)) {
                <div class="error"
                  >
                  @if (confirmPasswordInput.errors?.['required']) {
                    <div>Please confirm your password.</div>
                  }
                </div>
              }
              @if ((confirmPassword && password && !passwordsMatch) && ((confirmPasswordInput.touched || confirmPasswordInput.dirty) || submitted)) {
                <div class="error"
                  >
                  Passwords do not match.
                </div>
              }
            </div>

            <div class="submitButtonContainer">
              <button type="submit" class="submitButton"
        [disabled]="
          signUpForm.invalid ||
          !usernameValid ||
          !allPasswordValidationsMet() ||
          !passwordsMatch||
          isLoading
        ">
                @if (!isLoading) {
                  <span>Create an account</span>
                }
                @if (isLoading) {
                  <span>Creating account...</span>
                }
              </button>
            </div>
          </form>
        </div>


        <!-- LOADER OVERLAY WITH COUNTDOWN -->
        @if (isLoading) {
          <div class="loaderOverlay">
            <div class="loaderBox">
              <div class="spinner"></div>
              <div class="loaderText">
                Creating account...
              </div>
            </div>
          </div>
        }